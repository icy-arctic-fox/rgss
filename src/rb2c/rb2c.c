// Ruby script to C code conversion utility.
// Generates a C file with a string containing raw data from the contents of a Ruby script.
// Original code found here: http://stackoverflow.com/a/11814544
// Code modified from the original.

#include <stdlib.h>
#include <stdio.h>
#include <string.h>

FILE* tryOpen (const char *path, const char *mode)
{
    FILE* f = fopen(path, mode);
    if(f == NULL)
    {
        perror(path);
        exit(EXIT_FAILURE);
    }
    return f;
}

void printUsage (char *progName)
{
    fprintf(stderr, "Usage: %s <INPUT> <OUTPUT> <SYMBOL>\n"
                    "  Creates <OUTPUT> file from the contents of <INPUT>\n"
                    "  A char array named <SYMBOL> will be defined in <OUTPUT>\n",
            progName);
    exit(EXIT_FAILURE);
}

void printHexContents (FILE *inFile, FILE *outFile)
{
    unsigned char buffer[1024];
    int bytes;   // Number of bytes read.
    int linePos; // Number of hex values printed to the current line.
    int i;       // Loop iterator for current byte.
    linePos = 0;

    // Continue looping until the end of the file is reached.
    do
    {
        // Read up until the buffer is full.
        bytes = fread(buffer, 1, sizeof(buffer), inFile);

        // Print the hex format of each byte.
        for(i = 0; i < bytes; i++)
        {
            fprintf(outFile, "0x%02x, ", buffer[i]);

            // Start a new line every 16 hex values.
            if(++linePos >= 16)
            {
                fprintf(outFile, "\n");
                linePos = 0;
            }
        }
    } while(bytes > 0);
}

void generateOutputFile (const char *inFileName, const char *outFileName, const char *symbol)
{
    // Try to open the input and output files.
    FILE *inFile, *outFile;
    inFile  = tryOpen(inFileName, "r");
    outFile = tryOpen(outFileName, "w");

    // Print initial declaration.
    fprintf(outFile, "/* Auto-generated by rb2c\n"
                     "   Contents generated from: %s */\n", inFileName);
    fprintf(outFile, "#include <stdlib.h>\n");
    fprintf(outFile, "const char %s[] = {\n", symbol);

    // Print the hex contents of the input file.
    printHexContents(inFile, outFile);

    // Print closing to declaration.
    fprintf(outFile, "0x00 };\n"); // Make sure to put a NULL-terminator at the end.
    fprintf(outFile, "const size_t %s_len = sizeof(%s);\n", symbol, symbol);

    // Close the files.
    fclose(inFile);
    fclose(outFile);
}

int main (int argc, char **argv)
{
    const char *rubyFileName, *cFileName, *symbol;

    // Check arguments.
    if(argc < 4)
        printUsage(argv[0]);

    // Get arguments and the output filename.
    rubyFileName = argv[1];
    cFileName    = argv[2];
    symbol       = argv[3];

    generateOutputFile(rubyFileName, cFileName, symbol);

    return EXIT_SUCCESS;
}
